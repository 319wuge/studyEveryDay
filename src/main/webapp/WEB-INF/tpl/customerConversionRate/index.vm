#parse("/common/constants.vm")
<!DOCTYPE html>
<html>
<!--[if IE 8]>
<html lang="en" class="ie8 no-js"> <![endif]-->
<!--[if IE 9]>
<html lang="en" class="ie9 no-js"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en" class="no-js">
<!--<![endif]-->
<!-- BEGIN HEAD -->
<head>
    #parse("/common/head.vm")
</head>
<!-- END HEAD -->
<!-- BEGIN BODY -->
<body class="page-header-fixed page-sidebar-fixed page-footer-fixed">
    #parse("/common/topbar.vm")
<div class="clearfix">
</div>
<!-- BEGIN CONTAINER -->
<div class="page-container">
    #parse("/common/menu.vm")
    <!-- BEGIN CONTENT -->
    <div class="page-content-wrapper">
        <div class="page-content">
            <!-- BEGIN SAMPLE PORTLET CONFIGURATION MODAL FORM-->
            <!-- END SAMPLE PORTLET CONFIGURATION MODAL FORM-->
            <!-- BEGIN PAGE HEADER-->
            <!-- END PAGE HEADER-->
            <!-- BEGIN PAGE CONTENT-->
            <div class="row">
                <div class="col-md-12">
                    <div class="portlet">
                        <div class="portlet-title">
                            <div class="caption" id="contractCountDiv">${Title} &nbsp;&nbsp;&nbsp;&nbsp;
                            </div>
                        </div>
                    </div>
                </div>

##                <div class="col-md-12" style="padding-bottom: 10px">
##                    #parse("/common/selectOrg.vm")
##                </div>
                <div class="col-md-12" style="padding-bottom: 10px">
                    #parse("/common/selectRateOrg.vm")
                </div>
                <div class="col-md-12" style="padding-bottom: 10px">
                    开始&nbsp;<input id="startDate" type="text" class="easyui-datebox" data-options="editable:false" value="$!startDate">
                    结束&nbsp;<input id="endDate" type="text" class="easyui-datebox" data-options="editable:false" value="$!endDate">
                    #if($select_level && $select_level >= 6)
                        手机&nbsp;<input id="mobile" name="mobile" class="easyui-textbox"/>
                        经纪人ID&nbsp;<input id="agentId" name="agentId" class="easyui-textbox"/>
                    #end

                    <a class="btn btn-xs green" onclick="reQueryData()">查询 <i class="fa fa-search"></i></a>
                    <a class="btn btn-xs green" onclick="exportData()">导出Excel <i class="fa fa-share-square-o"></i></a>
                </div>

                <div class="col-md-12">
                    <table id="report_dg" style="width:100%;">
                    </table>
                </div>
            </div>
            <!-- END PAGE CONTENT-->
        </div>
    </div>
    <!-- END CONTENT -->
</div>
<!-- END CONTAINER -->
    #parse("/common/footer.vm")
<iframe id="downloadExcel" style="display: none"></iframe>
<script type="text/javascript">
    function report_create_datagrid(pars) {
        var cols = getContrastTitle();
        //构造列表
        $('#report_dg').datagrid({
            url:'$!{basePath}/customerConversionRate/queryData.json',
            striped : true,
            pagination : true,
            rownumbers : true,
            pageSize : 15,
            pageNumber : 1,
            pageList : [15, 30, 100],
            loadMsg : '数据正在加载中...',
            queryParams : pars,
            singleSelect:true,
            selectOnCheck : false,
            checkOnSelect : false,
            frozenColumns: [cols.frozenColumns, []],
            columns : cols.columns,
            onLoadSuccess:function(data){
                $(".txtcenter").parent().parent().css("text-align","center");
                $("#report_dg").datagrid('resize');
                $('#report_dg').datagrid('resize');
            }
        });
    }

    //动态列表,包括固定和非固定列
    function getContrastTitle(){
        var cols = '[{"colspan":6,"isLevel":1,"ishidden":0,"field":"-","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":0,"title":"租赁","showUnit":0},{"colspan":9,"isLevel":1,"ishidden":0,"field":"-","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":0,"title":"二手","showUnit":0},{"colspan":9,"isLevel":1,"ishidden":0,"field":"-","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":0,"title":"一手","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"customerResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":2,"title":"上客数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"lookResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"带看数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"dealResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":2,"title":"成交数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"customerWithLook","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"上客转带看","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"customerWithDeal","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"上客转成交","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"lookWithDeal","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"带看转成交","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"saleCustomerResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"上客数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"saleLookResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"带看数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"saleSignResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"签居间数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"saleNetResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"网签数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"saleCustomerWithLook","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"上客转带看","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"saleCustomerWithSign","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"上客转居间","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"saleCustomerWithNet","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"上客转网签","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"saleLookWithSign","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"带看转居间","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"saleSignWithNet","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"居间转网签","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"firstRentCustomerResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"一手出租上客数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"firstSaleCustomerResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"一手出售上客数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"firstLookResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"带看数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"firstSubResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"认购数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"firstDealResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"成交数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"firstCustomerWithLook","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"上客转带看","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"firstCustomerWithSub","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"上客转认购","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"firstCustomerWithDeal","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"上客转成交","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"firstLookWithDeal","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"带看转成交","showUnit":0}]';
        cols = cols == '' ? [] :[{"colspan":6,"isLevel":1,"ishidden":0,"field":"-","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":0,"title":"租赁","showUnit":0},{"colspan":9,"isLevel":1,"ishidden":0,"field":"-","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":0,"title":"二手","showUnit":0},{"colspan":9,"isLevel":1,"ishidden":0,"field":"-","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":0,"title":"一手","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"customerResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":2,"title":"上客数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"lookResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"带看数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"dealResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":2,"title":"成交数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"customerWithLook","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"上客转带看","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"customerWithDeal","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"上客转成交","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"lookWithDeal","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"带看转成交","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"saleCustomerResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"上客数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"saleLookResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"带看数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"saleSignResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"签居间数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"saleNetResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"网签数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"saleCustomerWithLook","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"上客转带看","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"saleCustomerWithSign","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"上客转居间","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"saleCustomerWithNet","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"上客转网签","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"saleLookWithSign","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"带看转居间","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"saleSignWithNet","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"居间转网签","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"firstRentCustomerResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"一手出租上客数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"firstSaleCustomerResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"一手出售上客数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"firstLookResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"带看数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"firstSubResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"认购数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"firstDealResult","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"成交数","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"firstCustomerWithLook","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"上客转带看","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"firstCustomerWithSub","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"上客转认购","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"firstCustomerWithDeal","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"上客转成交","showUnit":0},{"colspan":1,"isLevel":0,"ishidden":0,"field":"firstLookWithDeal","rowspan":1,"commAttr":0,"isFixation":0,"dbbAttr":1,"title":"带看转成交","showUnit":0}] ;
        var colfields = [], topColFields = [], frozenCols = [];
        for (var i=0; i<cols.length; i++) {
            var col = cols[i];
            var colInfo = {field : col.field, title : '<span class="txtcenter">' + formatTitle(col.title) + '</span>', resizable : true, hidden : false, sortable : false,  align: 'center'};
            if (col.ishidden == 1) {
                colInfo.hidden = true;
            };
            if (col.isFixation) { // 固定列
                colInfo.rowspan = 2;
                frozenCols.push(colInfo);
            } else { // 非固定列
//                colInfo.width = $(this).width()*0.03;
                if (col.isLevel == 1 || col.rowspan == 2) {
                    colInfo.align = 'center';
                    colInfo.rowspan = col.rowspan;
                    colInfo.colspan = col.colspan;
                    topColFields.push(colInfo);
                } else {
                    colInfo.align = 'right';
                    colInfo.rowspan = col.rowspan;
                    colInfo.colspan = col.colspan;
                    colfields.push(colInfo);
                }
            }
        }
        //判断类型
        if(${cusConType}==6){
            frozenColumns=[ {field : 'cityId', title : '城市ID', rowspan : 2, resizable : true, hidden : false, sortable : false,  align: 'center'},{field : 'orgName', title : '<span class="txtcenter">名称</span>', rowspan : 2, resizable : true, hidden : false, sortable : false,  align: 'center'}]
        }else if(${cusConType}==5){
            //大区
            frozenColumns=[ {field : 'bigareaId', title : '大区ID', rowspan : 2, resizable : true, hidden : false, sortable : false,  align: 'center'},{field : 'orgName', title : '<span class="txtcenter">名称</span>', rowspan : 2, resizable : true, hidden : false, sortable : false,  align: 'center'}]
        }else if(${cusConType}==4){
           //区域
            frozenColumns=[ {field : 'areaId', title : '区域ID', rowspan : 2, resizable : true, hidden : false, sortable : false,  align: 'center'},{field : 'orgName', title : '<span class="txtcenter">名称</span>', rowspan : 2, resizable : true, hidden : false, sortable : false,  align: 'center'}]
        }else  if(${cusConType}==3){
            //门店
            frozenColumns=[ {field : 'mendianId', title : '门店ID', rowspan : 2, resizable : true, hidden : false, sortable : false,  align: 'center'},{field : 'orgName', title : '<span class="txtcenter">名称</span>', rowspan : 2, resizable : true, hidden : false, sortable : false,  align: 'center'}]
        }else  if(${cusConType}==2){
            //小组
            frozenColumns=[ {field : 'mdName', title : '门店', rowspan : 2, resizable : true, hidden : false, sortable : false,  align: 'center'}, {field : 'groupId', title : '小组ID', rowspan : 2, resizable : true, hidden : false, sortable : false,  align: 'center'},{field : 'orgName', title : '<span class="txtcenter">名称</span>', rowspan : 2, resizable : true, hidden : false, sortable : false,  align: 'center'}]
        }else  if(${cusConType}==1){
            //经纪人
            frozenColumns=[ {field : 'mdName', title : '门店', rowspan : 2, resizable : true, hidden : false, sortable : false,  align: 'center'},{field : 'groupName', title : '小组', rowspan : 2, resizable : true, hidden : false, sortable : false,  align: 'center'},{field : 'agentId', title : '经纪人ID', rowspan : 2, resizable : true, hidden : false, sortable : false,  align: 'center'},{field : 'orgName', title : '<span class="txtcenter">名称</span>', rowspan : 2, resizable : true, hidden : false, sortable : false,  align: 'center'}]
        }
        return {frozenColumns: frozenColumns, columns: [topColFields,colfields]};
    }

    // 格式化标头,四个字后加回车
    function formatTitle (title) {
        var len = title.length;
        title = title.replace(/(\S{4})/g, '$1<br/>').replace(/<br\/>$/, '');
        return title;
    }


    function reQueryData() {
        //判断  是否是经纪人显示列表  是的话  没有填写手机号以及经纪人id的情况下 需要填写到门店
//        var pars = report_param_init();
//        if (typeof($('#report_dg').data().datagrid) == "undefined") {
//            report_create_datagrid(pars);
//            $('.page-sidebar, .header').on('click', '.sidebar-toggler', function (e) {
//                $('#report_dg').datagrid('resize');
//                $('#report_dg').datagrid('resize');
//            });
//        } else {
//            $('#report_dg').datagrid('reload', pars);
//        }
        if(${cusConType}!=1){
            var pars = report_param_init();
            if (typeof($('#report_dg').data().datagrid) == "undefined") {
                report_create_datagrid(pars);
                $('.page-sidebar, .header').on('click', '.sidebar-toggler', function (e) {
                    $('#report_dg').datagrid('resize');
                    $('#report_dg').datagrid('resize');
                });
            } else {
                $('#report_dg').datagrid('reload', pars);
            }
        }else{
            if($("input[name='agentId']").val()==""&&$("input[name='mobile']").val()==""){
                if($("input[name='select_dq']").val()==0||$("input[name='select_qy']").val()==0||$("input[name='select_md']").val()==0){
                    alert("当前没有填写经纪人id和手机号,请选择到门店");
                }else{
                    var pars = report_param_init();
                    if (typeof($('#report_dg').data().datagrid) == "undefined") {
                        report_create_datagrid(pars);
                        $('.page-sidebar, .header').on('click', '.sidebar-toggler', function (e) {
                            $('#report_dg').datagrid('resize');
                            $('#report_dg').datagrid('resize');
                        });
                    } else {
                        $('#report_dg').datagrid('reload', pars);
                    }
                }
            }else{
                var pars = report_param_init();
                if (typeof($('#report_dg').data().datagrid) == "undefined") {
                    report_create_datagrid(pars);
                    $('.page-sidebar, .header').on('click', '.sidebar-toggler', function (e) {
                        $('#report_dg').datagrid('resize');
                        $('#report_dg').datagrid('resize');
                    });
                } else {
                    $('#report_dg').datagrid('reload', pars);
                }
            }
        }

    }

    // 获得当前页的所有参数
    function getQueryParam () {
        var newPars = {}, pars = {
            "csId": getCsId(),
            "dqId": getDqId(),
            "qyId": getQyId(),
            "mdId": getMdId(),
            "xzId": getXzId(),
            "jjrId": getJjrId()
        };
        // 去掉为0的参数
        for (var o in pars) {
            if (pars[o] > 0) {
                newPars[o] = pars[o];
            }
        }
        // 返回合并的所有参数
        return $.extend({}, newPars, {
            "cusConRateType": '$!{cusConType}',
            "startDate": $("#startDate").datebox("getValue"),
            "endDate": $("#endDate").datebox("getValue"),
            "mobile": $("#mobile").val(),
            "agentId": $("#agentId").val()
        })
    }

    // 查询表格数据参数
    function report_param_init(){
        var pars = getQueryParam (), params = {};
        for (var o in pars) {
            params[o] = pars[o];
        }
        return params;
//      return {"csId" : getCsId(), "dqId": getDqId(), "qyId": getQyId(), "mdId": getMdId(), "xzId": getXzId(), "jjrId": getJjrId(), "reportType": reportType, "isDef": isDef, "startDate": startDate, "endDate": endDate, "mobile": mobile, "agentId": agentId};
    }

    // 导出所需参数
    function report_export_param() {
        var pars = getQueryParam (), params = '?';
        for (var o in pars) {
            params += o + '=' + pars[o] + '&';
        }
        params = params.replace(/&$/, '') //去掉最后的&
//      var params = "?csId=" + getCsId() + "&dqId=" + getDqId() + "&qyId=" + getQyId() + "&mdId=" + getMdId() + "&xzId=" + getXzId() + "&jjrId=" + getJjrId() + "&reportType=" + reportType + "&isDef=" + isDef + "&startDate=" + startDate + "&endDate=" + endDate + "&mobile=" + mobile + "&agentId=" + agentId;
        return params;

    }


    function exportData() {
        var params = report_export_param();
        if(params == -1){
            return ;
        }
        var src = "$!{basePath}/customerConversionRate/exportData.report";
        $("#downloadExcel").attr("src", src + params);
    }

    function init() {

    }
</script>

</body>
<!-- END BODY -->
</html>